name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Build and create shadow JAR
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: ./gradlew clean build shadowJar --no-daemon -PartifactVersion=${{ steps.version.outputs.VERSION }}
      
      - name: List generated JARs
        run: ls -lh build/libs/*.jar || echo "No JARs found"
      
      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: ./gradlew publish --no-daemon -PartifactVersion=${{ steps.version.outputs.VERSION }}
      
      - name: Find shadow JAR
        id: find_jar
        run: |
          JAR_FILE=$(ls build/libs/*-all.jar 2>/dev/null | head -1)
          if [ -z "$JAR_FILE" ]; then
            echo "ERROR: Shadow JAR not found!"
            ls -la build/libs/ || echo "build/libs directory not found"
            exit 1
          fi
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_FILE"
          ls -lh "$JAR_FILE"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## Version ${{ steps.version.outputs.VERSION }}
            
            ### Changes
            See commit history for details.
            
            ### Installation
            
            **Gradle:**
            ```kotlin
            dependencies {
                implementation("com.leaf:leaf-jdbc-driver:${{ steps.version.outputs.VERSION }}")
            }
            ```
            
            **Maven:**
            ```xml
            <dependency>
                <groupId>com.leaf</groupId>
                <artifactId>leaf-jdbc-driver</artifactId>
                <version>${{ steps.version.outputs.VERSION }}</version>
            </dependency>
            ```
          files: ${{ steps.find_jar.outputs.JAR_FILE }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
